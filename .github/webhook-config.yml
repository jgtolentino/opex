# GitHub Webhook Configuration for Agent Orchestrator
# Auto-routes GitHub events to appropriate agents

webhooks:
  - name: odoo-ci-guardian
    url: https://orchestrator.insightpulseai.net/webhook/github
    secret: ${{ secrets.WEBHOOK_SECRET }}
    events:
      - check_run
      - pull_request
      - push
      - workflow_run

    filters:
      repositories:
        - "jgtolentino/odoo-ce"
        - "jgtolentino/opex"

      paths:
        - ".github/workflows/**"
        - "addons/**"
        - "platform/odoo/**"
        - "**/__ manifest__.py"

    routing:
      # Route CI failures to odoo-oca-ci-fixer
      - name: ci-failure-fix
        when:
          event: check_run.completed
          conclusion: failure
          repo_pattern: "(?i)(odoo|oca)"
        agent: odoo-oca-ci-fixer
        auto_invoke: true
        payload:
          repo_snapshot: true
          ci_logs: true
          target_branches: "{{ pr.base.ref }}"

      # Route Enterprise contamination to odoo-oca-ci-fixer
      - name: enterprise-detection
        when:
          event: push
          files_changed:
            - "**/__manifest__.py"
            - "**/models/*.py"
          content_patterns:
            - "from odoo.addons.enterprise"
            - "web_studio"
            - "documents"
            - "iap"
        agent: odoo-oca-ci-fixer
        auto_invoke: true
        escalate: true
        notify:
          - type: mattermost
            channel: "#odoo-alerts"
            mention: "@devops"

      # Route OCA compliance issues
      - name: oca-compliance-check
        when:
          event: pull_request
          action: [opened, synchronize]
          files_changed:
            - "addons/**/__manifest__.py"
        agent: odoo-oca-ci-fixer
        auto_invoke: false  # Manual review required
        checks:
          - agpl_license
          - oca_structure
          - manifest_completeness

      # Route deployment changes
      - name: deployment-review
        when:
          event: pull_request
          files_changed:
            - "platform/odoo/docker/**"
            - "platform/odoo/scripts/**"
            - "infra/terraform/odoo/**"
        agent: odoo-oca-ci-fixer
        auto_invoke: false
        require_approval: true
        approvers:
          - "@devops"
          - "@platform-team"

# Notification Configuration
notifications:
  on_agent_invocation:
    - type: mattermost
      webhook: ${{ secrets.MATTERMOST_WEBHOOK }}
      channel: "#ci-alerts"
      template: |
        **Agent Invoked:** {{ agent.name }}
        **Trigger:** {{ event.type }}
        **Repository:** {{ repo.name }}
        **Details:** {{ event.details }}

  on_fix_applied:
    - type: github_comment
      template: |
        ## ðŸ¤– {{ agent.name }}

        I've detected and fixed the following issues:

        {{ fixes }}

        ### ðŸ“‹ Next Steps
        {{ next_steps }}

        ---
        *Generated by {{ agent.id }} v{{ agent.version }}*

  on_escalation:
    - type: email
      to: ["devops@insightpulseai.net"]
      subject: "Agent Escalation: {{ agent.name }}"
      template: |
        Agent {{ agent.name }} has escalated the following issue:

        **Reason:** {{ escalation.reason }}
        **Repository:** {{ repo.name }}
        **Details:** {{ escalation.details }}

        Please review and take action.

# Security Configuration
security:
  verify_signatures: true
  allowed_ips:
    - "192.30.252.0/22"  # GitHub webhooks
    - "185.199.108.0/22"
    - "140.82.112.0/20"

  rate_limiting:
    max_requests_per_minute: 60
    max_agents_per_hour: 20

  secrets:
    webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    orchestrator_api_key: ${{ secrets.ORCHESTRATOR_API_KEY }}

# Logging & Monitoring
logging:
  level: info
  destination: supabase
  table: orchestrator_logs
  include:
    - timestamp
    - event_type
    - agent_id
    - repo
    - success
    - duration_ms
    - error_message

monitoring:
  healthcheck_url: https://orchestrator.insightpulseai.net/health
  metrics_endpoint: https://orchestrator.insightpulseai.net/metrics
  alert_on:
    - high_failure_rate
    - agent_timeout
    - security_violation
