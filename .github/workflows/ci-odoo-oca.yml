name: Odoo 18 CE / OCA CI

on:
  push:
    branches: [ main, "18.0", "18.0-*" ]
  pull_request:
    branches: [ main, "18.0", "18.0-*" ]

permissions:
  contents: read
  pull-requests: write

env:
  ODOO_VERSION: "18.0"
  PYTHON_VERSION: "3.10"
  DB_NAME: "odoo"
  DAGGER_CACHE: "false"

jobs:
  lint:
    name: Lint & Static Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install base tooling
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black isort pylint
          # Optional OCA tools if you use them:
          # pip install oca-maintainer-tools

      - name: Run pre-commit
        run: |
          if [ -f .pre-commit-config.yaml ]; then
            pre-commit run --all-files
          else
            echo "No pre-commit config; skipping."
          fi

      - name: Enterprise contamination check
        run: |
          set -e
          if grep -R --line-number -E "enterprise|web_studio|documents|iap" addons/ || true; then
            echo "::error::Possible Odoo Enterprise/IAP dependency detected;"
            echo "remove these references or move them to a separate, non-CE repo."
            exit 1
          fi
          echo "No Enterprise/IAP strings found."

  tests:
    name: Unit & Odoo Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports: ["5432:5432"]

    env:
      # DB connection for Odoo
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: odoo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Odoo and dependencies
        run: |
          python -m pip install --upgrade pip
          # Expect requirements.txt to pin Odoo CE & addons deps
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: List addons
        run: |
          echo "Custom addons:"
          ls -1 addons || true

      - name: Run Odoo tests for custom modules
        run: |
          # Adjust module list to your repos' addons; the agent will
          # automatically inject the correct list when patching.
          MODULES="${ODOO_MODULES:-all}"

          odoo \
            -d "$DB_NAME" \
            -i "$MODULES" \
            --stop-after-init \
            --log-level=test \
            --test-enable

  openupgrade-smoke:
    name: OpenUpgrade Smoke (optional)
    if: github.ref == 'refs/heads/18.0'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install OpenUpgrade tools
        run: |
          python -m pip install --upgrade pip
          pip install openupgradelib

      - name: Check migration scripts
        run: |
          if [ -d openupgrade_scripts ]; then
            echo "Found openupgrade_scripts; running import check..."
            python -m compileall openupgrade_scripts
          else
            echo "No openupgrade_scripts directory; skipping."
          fi
